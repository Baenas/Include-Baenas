<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Plantilla - Seguimiento de clases de Ciberseguridad</title>
    <style>
         :root {
            --bg: #fbfdff;
            --card: #ffffff;
            --muted: #6b7280;
            --accent: #1e90ff;
            --accent-2: #06b6d4;
            --border: #e6eef8;
            --success: #16a34a;
        }
        
        * {
            box-sizing: border-box
        }
        
        body {
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background: var(--bg);
            color: #0f172a;
            margin: 0;
            padding: 20px
        }
        
        .container {
            max-width: 980px;
            margin: 0 auto
        }
        
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px
        }
        
        h1 {
            font-size: 1.25rem;
            margin: 0
        }
        
        .meta {
            display: flex;
            gap: 12px;
            align-items: center
        }
        
        .date {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 10px;
            min-width: 210px;
            display: flex;
            flex-direction: column
        }
        
        .date small {
            color: var(--muted);
            font-size: 12px
        }
        
        .controls {
            display: flex;
            gap: 8px
        }
        
        button {
            background: transparent;
            border: 1px solid var(--accent);
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer
        }
        
        button.ghost {
            border-color: var(--border)
        }
        
        main {
            display: grid;
            grid-template-columns: 1fr;
            gap: 14px
        }
        
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 14px;
            border-radius: 12px
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px
        }
        
        textarea {
            width: 100%;
            min-height: 90px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            resize: vertical
        }
        
        input[type='text'],
        input[type='date'] {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid var(--border)
        }
        
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px
        }
        
        .small {
            font-size: 0.9rem;
            color: var(--muted)
        }
        
        footer {
            margin-top: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center
        }
        
        .tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }
        
        .tag {
            background: #f1f9ff;
            border: 1px solid #d4ecff;
            padding: 6px 8px;
            border-radius: 999px;
            font-size: 13px
        }
        
        .print-hint {
            font-size: 13px;
            color: var(--muted)
        }
        /* printable styles */
        
        @media print {
            body {
                padding: 8mm;
                color: #000;
                background: #fff
            }
            header .controls,
            .no-print {
                display: none
            }
            .card {
                box-shadow: none;
                border: none;
                border-radius: 0;
                padding: 0;
                margin-bottom: 10px
            }
            textarea,
            input {
                border: none
            }
        }
        /* small screens */
        
        @media (max-width:640px) {
            .two-col {
                grid-template-columns: 1fr
            }
        }
        /* subtle helper styles */
        
        .flex {
            display: flex;
            gap: 8px;
            align-items: center
        }
        
        .checkboxes {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }
        
        .mini {
            font-size: 12px;
            color: var(--muted)
        }
        
        .counter {
            font-size: 12px;
            color: var(--muted);
            margin-left: auto
        }
        
        .link-list {
            padding-left: 14px;
            margin: 6px 0
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div>
                <h1>Seguimiento de clase — Ciberseguridad</h1>
                <div class="small">Plantilla para anotar objetivos, conceptos clave, ejercicios y referencias.</div>
            </div>

            <div class="meta">
                <div class="date card">
                    <small>Fecha de la sesión</small>
                    <input id="fechaActual" type="text" aria-label="Fecha de la sesión" readonly>
                </div>
                <div class="controls no-print">
                    <button id="guardarLocal">Guardar local</button>
                    <button id="limpiar">Limpiar</button>
                    <button id="imprimir">Imprimir</button>
                </div>
            </div>
        </header>

        <main>
            <section class="card">
                <label for="objetivos">Objetivos de la sesión</label>
                <textarea id="objetivos" placeholder="Escribe los objetivos..."></textarea>
                <div class="flex mini">
                    <div class="checkboxes">
                        <label><input type="checkbox" id="completado"> Sesión completada</label>
                        <label><input type="checkbox" id="esencial"> Contenido esencial</label>
                    </div>
                    <div class="counter" id="charCountObj">0 caracteres</div>
                </div>
            </section>

            <section class="card">
                <label for="resumen">Resumen / Notas principales</label>
                <textarea id="resumen" placeholder="Resumen rápido o notas detalladas..."></textarea>
            </section>

            <section class="card two-col">
                <div>
                    <label for="conceptos">Conceptos clave</label>
                    <textarea id="conceptos" placeholder="Listar conceptos y definiciones importantes"></textarea>
                </div>
                <div>
                    <label for="ejercicios">Ejercicios y prácticas para casa</label>
                    <textarea id="ejercicios" placeholder="Descripción de ejercicios, comandos, laboratorios..."></textarea>
                </div>
            </section>

            <section class="card">
                <label for="referencias">Referencias / Enlaces</label>
                <textarea id="referencias" placeholder="URLs, libros, RFCs, artículos... (uno por línea)"></textarea>
                <div class="mini">Al pegar enlaces, puedes imprimirlos o abrirlos desde el documento.</div>
            </section>

            <section class="card">
                <label for="etiquetas">Etiquetas / Categorías</label>
                <input id="etiquetas" type="text" placeholder="ej: red, pentesting, criptografía (separadas por comas)">
                <div class="tags" id="tagPreview" aria-hidden="true"></div>
            </section>

            <section class="card">
                <label for="detalles">Detalles técnicos rápidos</label>
                <div class="small">Puertos, herramientas usadas, comandos importantes</div>
                <textarea id="detalles" placeholder="Ej: nmap -sC -sV 10.0.0.5; openssl s_client -connect ..."></textarea>
            </section>

        </main>

        <footer>
            <div class="print-hint">Consejo: usa el botón "Guardar local" para mantener una copia en el navegador. Imprime con la opción "Imprimir".</div>
            <div>
                <button class="no-print" id="exportMd">Exportar a Markdown</button>
                <button class="no-print" id="clearStorage">Borrar guardado</button>
            </div>
        </footer>
    </div>

    <script>
        // Fecha actual
        const fechaInput = document.getElementById('fechaActual');
        const hoy = new Date();
        const opciones = {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        };
        fechaInput.value = hoy.toLocaleDateString('es-ES', opciones);

        // contador de caracteres objetivos
        const objetivos = document.getElementById('objetivos');
        const charCountObj = document.getElementById('charCountObj');

        function actualizarContador() {
            charCountObj.textContent = objetivos.value.length + ' caracteres';
        }
        objetivos.addEventListener('input', actualizarContador);
        actualizarContador();

        // tags preview
        const etiquetas = document.getElementById('etiquetas');
        const tagPreview = document.getElementById('tagPreview');
        etiquetas.addEventListener('input', () => {
            const tags = etiquetas.value.split(',').map(t => t.trim()).filter(Boolean);
            tagPreview.innerHTML = tags.map(t => `<span class="tag">${t}</span>`).join(' ');
        });

        // Guardar en localStorage
        const guardarLocalBtn = document.getElementById('guardarLocal');
        const limpiarBtn = document.getElementById('limpiar');
        const imprimirBtn = document.getElementById('imprimir');
        const exportMdBtn = document.getElementById('exportMd');
        const clearStorageBtn = document.getElementById('clearStorage');

        function getState() {
            return {
                fecha: fechaInput.value,
                objetivos: objetivos.value,
                resumen: document.getElementById('resumen').value,
                conceptos: document.getElementById('conceptos').value,
                ejercicios: document.getElementById('ejercicios').value,
                referencias: document.getElementById('referencias').value,
                etiquetas: etiquetas.value,
                detalles: document.getElementById('detalles').value,
                completado: document.getElementById('completado').checked,
                esencial: document.getElementById('esencial').checked
            }
        }

        function setState(state) {
            if (!state) return;
            fechaInput.value = state.fecha || fechaInput.value;
            objetivos.value = state.objetivos || '';
            document.getElementById('resumen').value = state.resumen || '';
            document.getElementById('conceptos').value = state.conceptos || '';
            document.getElementById('ejercicios').value = state.ejercicios || '';
            document.getElementById('referencias').value = state.referencias || '';
            etiquetas.value = state.etiquetas || '';
            document.getElementById('detalles').value = state.detalles || '';
            document.getElementById('completado').checked = !!state.completado;
            document.getElementById('esencial').checked = !!state.esencial;
            etiquetas.dispatchEvent(new Event('input'));
            actualizarContador();
        }

        guardarLocalBtn.addEventListener('click', () => {
            localStorage.setItem('plantilla_ciber', JSON.stringify(getState()));
            guardarLocalBtn.textContent = 'Guardado ✓';
            setTimeout(() => guardarLocalBtn.textContent = 'Guardar local', 1500);
        });

        // cargar al iniciar si existe
        window.addEventListener('load', () => {
            try {
                const s = JSON.parse(localStorage.getItem('plantilla_ciber'));
                if (s) setState(s);
            } catch (e) {}
        });

        limpiarBtn.addEventListener('click', () => {
            if (confirm('¿Limpiar todos los campos de la plantilla?')) {
                setState({});
            }
        });

        clearStorageBtn.addEventListener('click', () => {
            if (confirm('Borrar los datos guardados en este navegador?')) {
                localStorage.removeItem('plantilla_ciber');
                alert('Guardado borrado');
            }
        });

        imprimirBtn.addEventListener('click', () => window.print());

        async function guardarEnGitHubWorkflow(fecha, contenido) {
            const resp = await fetch("../api/dispatch", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    fecha,
                    markdown: contenido
                })
            });

            const data = await resp.json();
            if (resp.ok) {
                alert("✅ " + data.msg);
            } else {
                alert("❌ Error: " + JSON.stringify(data.err));
            }
        }

        // Exportar a Markdown básico
        exportMdBtn.addEventListener("click", async() => {
            const s = getState();
            const fechaISO = new Date().toISOString().slice(0, 10);
            const md = `# Sesión - ${s.fecha}\n\n## Objetivos\n${s.objetivos}\n\n## Resumen / Notas\n${s.resumen}\n\n## Conceptos clave\n${s.conceptos}\n\n## Ejercicios\n${s.ejercicios}\n\n## Referencias\n${s.referencias}\n\n## Etiquetas\n${s.etiquetas}\n\n## Detalles técnicos\n${s.detalles}\n`;

            await guardarEnGitHubWorkflow(fechaISO, md);
        });
    </script>
</body>

</html>